{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vnetResourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The Resource Group Name that contains the Virtual Network that will be external."
      }
    },
    "vnetName": {
      "type": "string",
      "metadata": {
        "description": "The Name of the existing virtual network that you want to connect the BIG-IP's to."
      }
    },
    "externalSubnetName": {
      "type": "string",
      "metadata": {
        "description": "Name of first subnet - with External Acccess to Internet."
      }
    },
    "internalSubnetName": {
      "type": "string",
      "metadata": {
        "description": "Name of internal Subnet for UDR, NOT the subnet with the Servers in it."
      }
    },
    "f5Name": {
      "type": "string",
      "defaultValue": "bigip",
      "metadata": {
        "description": "The Unique Name of the BIG-IP instance, that will be used for the Public DNS Name of the Public IP."
      }
    },
    "f5Size": {
      "type": "string",
      "defaultValue": "Standard_F2",
      "allowedValues": [
        "Standard_F2",
        "Standard_A3",
        "Standard_A4"
      ],
      "metadata": {
        "description": "The size of the BIG-IP Instance."
      }
    },
    "numberOFBIG-IPs": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "The total number of BIG-IP's (Up to 4) you want to deploy."
      },
      "allowedValues": [
        1,
        2,
        3,
        4
      ]
    },
    "additionalInterfaces": {
      "type": "bool",
      "defaultValue": false,
      "allowedValues": [
        "true",
        "false"
      ],
      "metadata": {
        "description": "Do you want to deploy more than the default 2 interfaces?  Note: The total number of interfaces is dependant on the VM Instance Size that you have chosen."
      }
    },
    "numberOfAdditionalInterfaces": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "By default two interfaces are deployed.  If the VM instance that you have chosen supports more than two, you can specify the additional number of NIC's here.  So if you can have 4, you would specify 2 here.  Zero, means only 2 NIC's will be deployed."
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "User name to login to the BIG-IP."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password to login to the BIG-IP"
      }
    }
  },
  "variables": {
    "vnetID": "[resourceId(parameters('vnetResourceGroupName'),'Microsoft.Network/virtualNetworks',parameters('vnetName'))]",
    "subnet-idExternal": "[concat(variables('vnetID'),'/subnets/',parameters('externalSubnetName'))]",
    "subnet-idInternal": "[concat(variables('vnetID'),'/subnets/',parameters('internalSubnetName'))]",
    "avsetNamePrefix": "[concat(parameters('f5Name'),'-avset')]",
    "externalNICNamePrefix": "[concat(parameters('f5Name'),'-externalnic')]",
    "udrNICNamePrefix": "[concat(parameters('f5Name'),'-udrnic')]",
    "f5publicIPName": "[concat(parameters('f5Name'),'-IP')]",
    "newStorageAccountName": "[concat(parameters('f5Name'),'store')]",
    "publicIPID": "[resourceId('Microsoft.Network/publicIPAddresses',variables('f5publicIPName'))]",
    "nicHash": {
      "false": "[concat()]",
      "true": "[concat()]"
    }
  },
  "resources": [
    {
      "name": "[variables('avsetNamePrefix')]",
      "tags": {
        "displayName": "Availability Set"
      },
      "type": "Microsoft.Compute/availabilitySets",
      "location": "[resourceGroup().location]",
      "apiVersion": "2015-05-01-preview",
      "properties": {
        "platformUpdateDomainCount": 1,
        "platformFaultDomainCount": 1
      }
    },
    {
      "name": "[variables('newStorageAccountName')]",
      "tags": {
        "displayName": "StorageAccount"
      },
      "type": "Microsoft.Storage/storageAccounts",
      "location": "[resourceGroup().location]",
      "apiVersion": "2015-05-01-preview",
      "properties": {
        "accountType": "Standard_LRS"
      }
    },
    {
      "apiVersion": "2015-05-01-preview",
      "tags": {
        "displayName": "Public IP Address"
      },
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('f5publicIPName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "publicIPAllocationMethod": "Dynamic",
        "dnsSettings": {
          "domainNameLabel": "[parameters('f5Name')]"
        }
      }
    },
    {
      "apiVersion": "2015-01-01",
      "name": "NICTemplate",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/tstanley93/OpenCart-WAF/master/OpenCart-WAF/openCartInfrastructureTemplate.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "namePrefix": { "value": "[parameters('namePrefix')]" },
          "location": { "value": "[parameters('location')]" }
        }
      }
    },
    {
      "apiVersion": "2015-05-01-preview",
      "tags": {
        "displayName": "BIG-IP VM"
      },
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[parameters('f5Name')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/',variables('externalNICNamePrefix'))]",
        "[concat('Microsoft.Network/networkInterfaces/',variables('udrNICNamePrefix'))]",
        "[concat('Microsoft.Storage/storageAccounts/', variables('newStorageAccountName'))]",
        "[concat('Microsoft.Compute/availabilitySets/', variables('avsetNamePrefix'))]"
      ],
      "plan": {
        "name": "f5-bigip-virtual-edition-best-byol",
        "publisher": "f5-networks",
        "product": "f5-big-ip"

      },
      "properties": {
        "availabilitySet": {
          "id": "[resourceId('Microsoft.Compute/availabilitySets',variables('avsetNamePrefix'))]"
        },
        "hardwareProfile": {
          "vmSize": "[parameters('f5Size')]"
        },
        "osProfile": {
          "computerName": "[parameters('f5Name')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "f5-networks",
            "offer": "f5-big-ip",
            "sku": "f5-bigip-virtual-edition-best-byol",
            "version": "latest"
          },
          "osDisk": {
            "name": "[concat(parameters('f5Name'), 'osDisk')]",
            "vhd": {
              "uri": "[concat('http://',variables('newStorageAccountName'),'.blob.core.windows.net/',variables('newStorageAccountName'),'/',parameters('f5Name'),'.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('externalNICNamePrefix'))]",
              "properties": {
                "primary": true
              }
            },
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('udrNICNamePrefix'))]",
              "properties": {
                "primary": false
              }
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": true,
            "storageUri": "[concat('http://',variables('newstorageAccountName'),'.blob.core.windows.net')]"
          }
        }
      }
    }
  ],
  "outputs": {
    "GUI-URL": {
      "type": "string",
      "value": "[concat('https://',reference(variables('publicIPID')).dnsSettings.fqdn)]"
    },
    "SSH-URL": {
      "type": "string",
      "value": "[concat(reference(variables('publicIPID')).dnsSettings.fqdn)]"
    }
  }
}